const superagent  = require('superagent')
const querystring = require('querystring')

const getApiUrl = (userId, page) => {
  const apiPrefix = 'http://m.weibo.cn/container/getIndex?'
  const containerIdPrefix = '107603'           // meaning get all weibos insdead of the filterd one 
  const req = {
    page        : page,
    uid         : userId,
    containerid : containerIdPrefix + userId,
  }
  return apiPrefix + querystring.stringify(req)
}

const getPageCounts = (userId) => 
  new Promise((resolve, reject) => 
    superagent
      .get(getApiUrl(userId, 1))               // any page is OK. I choose page 1
      .end((err, res) => {
        if (err) reject(err)
        const { total } = JSON.parse(res.res.text).cardlistInfo
        resolve(Math.ceil(total / 10))        // each page has 10 cards
      })
  )

module.exports = (userId) => 
  getPageCounts(userId).then(counts => {
    let urls = []
    for (let i = 1; i <= counts; i++) {
      urls.push(getApiUrl(userId, i))
    }
    return urls
  })